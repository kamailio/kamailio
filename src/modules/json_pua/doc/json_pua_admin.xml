<?xml version="1.0" encoding='ISO-8859-1'?>
<!DOCTYPE book PUBLIC "-//OASIS//DTD DocBook XML V4.4//EN"
"http://www.oasis-open.org/docbook/xml/4.4/docbookx.dtd" [

<!-- Include general documentation entities -->
<!ENTITY % docentities SYSTEM "../../../../doc/docbook/entities.xml">
%docentities;

]>
<!-- Module User's Guide -->

<chapter xmlns:xi="http://www.w3.org/2001/XInclude">
	<title>&adminguide;</title>


	<section>
		<title>Overview</title>
		<para>The JSON_PUA module adds support to publish updates to the presence module through the json_pua_publish() function.
		</para>
		<para>
			From a high-level perspective, the module may be used for:
			<itemizedlist>
				<listitem>
					<para>
						Providing a real-time presence updates.
					</para>
				</listitem>
			</itemizedlist>
		</para>

	</section>
	<section>
		<title>How it works</title>
		<para>
			The module parses json data objects and inserts them into the presentity table for real-time presence updates.
		</para>
	</section>

	<section>
		<title>Dependencies</title>
		<section>
			<title>&kamailio; Modules</title>
			<para>
				The following modules must be loaded before this module:
				<itemizedlist>
					<listitem>
						<para>
							<emphasis>none</emphasis>.
						</para>
					</listitem>
				</itemizedlist>
			</para>
		</section>
		<section>
			<title>External Libraries or Applications</title>
			<para>
				The following libraries or applications must be installed
				<itemizedlist>
					<listitem>
						<para>
							<emphasis>libjson</emphasis>.
						</para>
					</listitem>
				</itemizedlist>
			</para>
		</section>
	</section>

	<section>
		<title>Parameters</title>
		<section>
			<title><varname>db_url</varname>(str)</title>
			<para>
				The database for the presentity table.
			</para>
			<para>
				If set, the json_pua_publish function will update the presentity status in the database.
			</para>
			<para>
				Usage: presence related.
			</para>
			<para>
				<emphasis>Default value is <quote>NULL</quote>.</emphasis>
			</para>
			<example>
			<title>Set <varname>db_url</varname> parameter</title>
<programlisting format="linespecific">
...
modparam("json_pua", "db_url", "&defaultdb;")
...
</programlisting>
			</example>
		</section>

		<section>
			<title><varname>presentity_table</varname>(str)</title>
			<para>
				The name of the presentity table in the database.
			</para>
			<para>
				<emphasis>Default value is <quote>presentity</quote>.</emphasis>
			</para>
			<example>
				<title>Set <varname>presentity_table</varname> parameter</title>
<programlisting format="linespecific">
...
modparam("json_pua", "presentity_table", "my_presentity_table")
...
</programlisting>
			</example>
		</section>

		<section>
			<title><varname>db_table_lock_type</varname>(int)</title>
			<para>
			Enable (=1) or disable (=0) the locks for table during a
			transaction.
			</para>
			<para>
				<emphasis>Default value is <quote>1</quote>.</emphasis>
			</para>
			<example>
				<title>Set <varname>db_table_lock_type</varname> parameter</title>
<programlisting format="linespecific">
...
modparam("json_pua", "db_table_lock_type", 0)
...
</programlisting>
			</example>
		</section>

	</section>
	<section>
		<title>Functions</title>
		<section>
			<title>
				<function moreinfo="none">json_pua_publish(json_payload)</function>
			</title>
			<para>
				The function build presentity state from json_payload and updates presentity table.
			</para>
			<para>
				Usage: presence related.
			</para>
			<para>
				This function can be used from ANY ROUTE.
			</para>

			<example>
				<title><function>json_pua_publish</function> usage</title>
<programlisting format="linespecific">
...
event_route[xhttp:request] {
	$var(call-id) = $(rb{json.parse,Call-ID});
	if ($(rb{json.parse,Event-Package}) == "dialog") {
		xlog("L_INFO", "$var(call-id)|log|received $(rb{json.parse,Event-Package}) update for $(rb{json.parse,From})");
		json_pua_publish($rb);
		pres_refresh_watchers("$(tb{json.parse,From})", "$(rb{json.parse,Event-Package})", 1);
	}
}
...
</programlisting>
			</example>
		</section>

	</section>


</chapter>

