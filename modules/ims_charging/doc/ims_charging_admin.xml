<?xml version="1.0" encoding="ISO-8859-1"?>
<!DOCTYPE book PUBLIC "-//OASIS//DTD DocBook XML V4.4//EN"
"http://www.oasis-open.org/docbook/xml/4.4/docbookx.dtd" [
<!-- Include general documentation entities -->
<!ENTITY % docentities SYSTEM "../../../docbook/entities.xml">
%docentities;
]>
<!-- Auth_db Module User's Guide -->
<chapter>
  <title>&adminguide;</title>

  <section>
    <title>Overview</title>

    <para>This module contains all methods related to the IMS charging control
	functions performed by an network element (e.g. a S-CSCF) over the Ro
	interface. This module is dependent on the CDP (C Diameter Peer)
	modules for communicating with a Charging-Server as specified in 3GPP 
	specification TS xx.xxx.
    </para>
<para>
	Please also refer to RFC 4006 (Diameter Credit-Control Application)
</para>
  </section>

  <section>
    <title>Dependencies</title>

    <section>
      <title>&kamailio; Modules</title>

      <para>The Following mouldes must be loaded before this module:</para>

      <itemizedlist>
        <listitem>
          <para>Dialog2</para>
        </listitem>

        <listitem>
          <para>TM - Transaction Manager</para>
        </listitem>

        <listitem>
          <para>CDP - C Diameter Peer</para>
        </listitem>

        <listitem>
          <para>CDP_AVP - CDP AVP Applications</para>
        </listitem>
      </itemizedlist>
    </section>

    <section>
      <title>External Libraries or Applications</title>

      <para>This modules requires the internal IMS library.</para>
    </section>

  <section>
    <title>Understanding Charging in the IP-Multimedia-Subsystem (IMS)</title>

    <para>Before each service usage, the charging system must be asked for permission (credit authorization). The charging server must make a decision: Either authorize or deny the session.
For postpaid scenarios this is fairly easy: The charging-server only needs to collect the usage data for processing it at the end of the month. As no realtime account updating is needed, this is often called „offline-charging“.
For prepaid scenarios the charging server needs to know the user's account balance and it will need to update the account in real-time. This is often referred to as „online-charging“.

Question: What is the double of the Radius?
Answer: It's the Diameter!

As quite often, we use the Diameter-Protocol to do the Charging in the IMS. And as quite often, IMS uses a huge bunch of acronyms to describe the different interfaces: We call the diameter-interface for offline-charging the „Rf“-interface and the interface for online charging the „Ro“-interface.

Each system, that needs this credit authorization, have to be equipped with a proper charging trigger, a so-called charging-trigger-function (CTF) in order to communicate with the charging-server (also called charging-function):
    </para>
            <mediaobject>
              <imageobject>
				  <imagedata fileref="./images/charging1.png"/>
              </imageobject>
            </mediaobject>
  <section>
    <title>Offline Charging (Rf)</title>
    <para>For the offlinc charging (Rf), we have the following two diameter-messages:</para>
<itemizedlist>
 <listitem>
          <para>ACR – Accounting Request</para>
        </listitem>
 <listitem>
          <para>ACA – Accounting Answer</para>
        </listitem>

</itemizedlist>
<para>Each request can have the following Accounting-Record-Type:</para>
<itemizedlist>
 <listitem>
          <para>START_RECORD - used to start an accounting session, typically when the application receives a SIP 200 OK acknowledging an initial SIP INVITE.</para>
        </listitem>
 <listitem>
          <para>INTERIM_RECORD - used to update a session, for example, in the case of SIP RE-INVITE and/or UPDATE in the current SIP dialog.</para>
        </listitem>
 <listitem>
          <para>STOP_RECORD - used to stop an accounting session, for example, when the application receives a SIP BYE message.</para>
        </listitem>
 <listitem>
          <para>EVENT_RECORD – used for event-based accounting, e.g. a short message or similar</para>
        </listitem>
</itemizedlist>
  </section>
  <section>
    <title>Online Charging (Ro)</title>
<para>For online charging (Ro), this get's a little bit more complicated. The charging function needs to perform credit control before allowing resource usage. The prepaid subscriber needs to exist in the charging-server and all activities must be monitored by the charging-server. We must distinguish between the following two cases:</para>
<itemizedlist>
 <listitem>
          <para>Direct debiting – the amount is immediately deducted from the user's account in one single transaction. This could be for example a SMS or the ordering of a movie in case of Video-on-Demand.</para>
        </listitem>
 <listitem>
          <para>Unit reservation – an amount is reserved by the charging-server. This is done, because the charging-server does not know yet, how many units are needed to provide the service. During the session, the used amount may be deducted and more units can be requested; at the end of the session the used sessions are reported in the final request. These sessions could be typically a voice- or video-call or a Pay-TV session, if you pay per usage.</para>
        </listitem>
</itemizedlist>
<para>
As a result, we have the following three scenarios:
</para>
<itemizedlist>
 <listitem>
          <para>Immediate Event Charging (IEC) - used for simple Event-based charging</para>
        </listitem>
 <listitem>
          <para>Event Charging with Unit Reservation (ECUR) (of type Event-based charging)</para>
        </listitem>
 <listitem>
          <para>Session Charging with Unit Reservation (SCUR) (of type Session-based charging)</para>
        </listitem>
</itemizedlist>
 </section>
  <section>
    <title>Online Charging (Ro)</title>
<para>But how does it look in reality? Let us make a more practical example:</para>
<para>Let us assume we have a subscriber, who has sufficient credit for 75 seconds of talking. The subscriber initiates a call; as we do not know, how long the call will take, we start with requesting credit for 30 seconds (CCR-Request, we could request any duration, e.g. 2 hours, but it would probably block other calls if we reserve all the required credit).</para>
<para>The call proceeds, so after 30 seconds we send another CCR-Request with the indication that we used the reserved 30 seconds and that we request another 30 seconds. We reduce the account of the subscriber by 30 seconds, so he has a credit of 45 seconds. Since 45 seconds is more than the requested 30 seconds, this second request can also easily be accepted and another 30 seconds can be granted. After this request, the account is at 45 seconds and we still (or again) have 30 seconds reserved.</para>
<para>Meanwhile the subscriber initiates a second call. We try to request again 30 seconds from the charging-server, but as our account is at 45 seconds of speaking time and since we reserved another 30 seconds for the first call, we can only grant 15 seconds for the second call. The last 15 seconds are now reserved for this subscriber; we have 45 seconds on the account of which 45 seconds are reserved.</para>
<para>Now the first call gets terminated: We only used 20 seconds from the granted 30 seconds. So we decrease the account of the subscriber by 20 seconds and we reduce the amount of reserved units by 30. We have 25 seconds in the account and we have still reserved 15 seconds for the second call.</para>
<para>As the second call is still proceeding, we will try to request another 30 seconds and we indicate, that we used the granted 15 seconds. The account is deducted by 15 seconds (the used units) and we can grant another 10 seconds for the second call, as this is the remains on the account.</para>
<para>After 10 seconds, no more units can be granted, so the call is teared down.</para>
<para>The following diagram is a graphical representation of the above example:</para>
            <mediaobject>
              <imageobject>
				  <imagedata fileref="./images/charging2.png"/>
              </imageobject>
            </mediaobject>

  </section>

  </section>

  <section>
    <title>Parameters</title>

    <section>
      <title><varname>hash_size</varname> (int)</title>

      <para>The size of the hash table internally used to keep the Diameter-Ro-Session. A larger table is much faster but consumes more memory. The hash size must be a power of two number.</para>
<para>
IMPORTANT: If Ro-Session's information should be stored in a database, a constant hash_size should be used, otherwise the restoring process will not take place. If you really want to modify the hash_size you must delete all table's rows before restarting the server.
</para>
      <para><emphasis> Default value is 4096.
      </emphasis></para>

      <example>
        <title><varname>hash_size</varname> parameter usage</title>

        <programlisting format="linespecific">
...
modparam("ims_charging", "hash_size", 1024)
...
        </programlisting>
      </example>
    </section>

    <section>
      <title><varname>interim_update_credits</varname> (int)</title>

      <para>How much credit should be requested interim request? At the start of the call, we request the amout of seconds as per Command. For each interim request, we would request credit for "interim_update_credits". </para>
      <para><emphasis> Default value is 30.
      </emphasis></para>

      <example>
        <title><varname>interim_update_credits</varname> parameter usage</title>

        <programlisting format="linespecific">
...
modparam("ims_charging", "interim_update_credits", 600)
...
        </programlisting>
      </example>
    </section>

    <section>
      <title><varname>timer_buffer</varname> (int)</title>

      <para>How many seconds before expiry of our credit should we request more credit?</para>

      <para><emphasis> Default value is 8.
      </emphasis></para>

      <example>
        <title><varname>timer_buffer</varname> parameter usage</title>

        <programlisting format="linespecific">
...
modparam("ims_charging", "timer_buffer", 10)
...
        </programlisting>
      </example>
    </section>

    <section>
      <title><varname>ro_forced_peer</varname> (string)</title>

      <para>This is the optional name of the origin host of the Diameter server
      (typically a Charging Server).  If not set then realm routing is used.</para>

      <para><emphasis> Default value is ''.
      </emphasis></para>

      <example>
        <title><varname>ro_forced_peer</varname> parameter usage</title>

        <programlisting format="linespecific">
...
modparam("ims_charging", "ro_forced_peer", "ocs.ims.smilecoms.com")
...
        </programlisting>
      </example>
    </section>

    <section>
      <title><varname>ro_auth_expiry</varname> (integer)</title>

      <para>This is the expiry length in seconds of the initiated 
      Diameter sessions.</para>

      <para><emphasis> Default value is 7200.
      </emphasis></para>

      <example>
        <title><varname>ro_auth_expiry</varname> parameter usage</title>

        <programlisting format="linespecific">
...
modparam("ims_charging", "ro_auth_expiry", 14400)
...
        </programlisting>
      </example>
    </section>

    <section>
      <title><varname>ro_auth_expiry</varname> (integer)</title>

      <para>This is the expiry length in seconds of the initiated 
      Diameter sessions.</para>

      <para><emphasis> Default value is 7200.
      </emphasis></para>

      <example>
        <title><varname>ro_auth_expiry</varname> parameter usage</title>

        <programlisting format="linespecific">
...
modparam("ims_charging", "ro_auth_expiry", 14400)
...
        </programlisting>
      </example>
    </section>

    <section>
      <title><varname>cdp_event_latency</varname> (integer)</title>

      <para>This is a flag to determine whether or slow CDP responses should be 
      reported in the log file. 1 is enabled and 0 is disabled.</para>

      <para><emphasis> Default value is 1.
      </emphasis></para>

      <example>
        <title><varname>cdp_event_latency</varname> parameter usage</title>

        <programlisting format="linespecific">
...
modparam("ims_charging", "cdp_event_latency", 1)
...
        </programlisting>
      </example>
    </section>
    
    <section>
      <title><varname>cdp_event_threshold</varname> (integer)</title>

      <para>This time in milliseconds is the limit we should report a CDP 
      response as slow. i.e. if a CDP response exceeds this limit it will be 
      reported in the log file.  This is only relevant is cdp_event_latency is 
      enabled (set to 0).
      </para>

      <para><emphasis> Default value is 500.
      </emphasis></para>

      <example>
        <title><varname>cdp_event_threshold</varname> parameter usage</title>

        <programlisting format="linespecific">
...
modparam("ims_charging", "cdp_event_threshold", 500)
...
        </programlisting>
      </example>
    </section>
    
    <section>
      <title><varname>cdp_event_latency_log</varname> (integer)</title>

      <para>This time log level at which we should report slow CDP responses. 
          0 is ERROR, 1 is WARN, 2 is INFO and 3 is DEBUG. This is only 
          relevant is cdp_event_latency is enabled (set to 0)
      </para>

      <para><emphasis> Default value is 0.
      </emphasis></para>

      <example>
        <title><varname>cdp_event_latency_log</varname> parameter usage</title>

        <programlisting format="linespecific">
...
modparam("ims_charging", "cdp_event_latency_log", 1)
...
        </programlisting>
      </example>
    </section>

    <section>
      <title><varname>origin_host</varname> (string)</title>

      <para>Origin host to be used in Diameter messages to charging-server.</para>

      <para><emphasis> Default value is "scscf.ims.smilecoms.com".
      </emphasis></para>

      <example>
        <title><varname>origin_host</varname> parameter usage</title>

        <programlisting format="linespecific">
...
modparam("ims_charging", "origin_host", "scscf.kamailio-ims.org")
...
        </programlisting>
      </example>
    </section>

    <section>
      <title><varname>origin_realm</varname> (string)</title>

      <para>Origin Realm to be used in Diameter messages to charging-server.</para>

      <para><emphasis> Default value is "ims.smilecome.com".
      </emphasis></para>

      <example>
        <title><varname>origin_realm</varname> parameter usage</title>

        <programlisting format="linespecific">
...
modparam("ims_charging", "origin_realm", "kamailio-ims.org")
...
        </programlisting>
      </example>
    </section>

    <section>
      <title><varname>destination_host</varname> (string)</title>

      <para>Destination host to be used in Diameter messages to charging-server.</para>

      <para><emphasis> Default value is 5s.
      </emphasis></para>

      <example>
        <title><varname>destination_host</varname> parameter usage</title>

        <programlisting format="linespecific">
...
modparam("ims_charging", "destination_host", "ocs.kamailio-ims.org")
...
        </programlisting>
      </example>
    </section>

    <section>
      <title><varname>destination_realm</varname> (string)</title>

      <para>Destination realm to be used in Diameter messages to charging-server.</para>

      <para><emphasis> Default value is "ims.smilecoms.com".
      </emphasis></para>

      <example>
        <title><varname>destination_realm</varname> parameter usage</title>

        <programlisting format="linespecific">
...
modparam("ims_charging", "destination_realm", "kamailio-ims.org")
...
        </programlisting>
      </example>
    </section>

    <section>
      <title><varname>service_context_id_root</varname> (string)</title>

      <para>This defines a root-element of the Service-Context-Id AVP used
 in the diameter-message</para>
<para>The Service-Context-Id AVP is of type UTF8String (AVP Code 461) and 
contains a unique identifier of the Diameter credit-control service
   specific document that applies to the request (as defined in section RFC 4006
   4.1.2).  This is an identifier allocated by the service provider, by
   the service element manufacturer, or by a standardization body, and
   MUST uniquely identify a given Diameter credit-control service
   specific document.  The format of the Service-Context-Id is:</para>
<programlisting format="linespecific">
   "service-context" "@" "domain"

   service-context = Token
</programlisting>
<para>The Token is an arbitrary string of characters and digits.</para>
<para>
   'domain' represents the entity that allocated the Service-Context-Id.
   It can be ietf.org, 3gpp.org, etc., if the identifier is allocated by
   a standardization body, or it can be the FQDN of the service provider
   (e.g., provider.example.com) or of the vendor (e.g.,
   vendor.example.com) if the identifier is allocated by a private
   entity.
</para>
<para>Service-specific documents that are for private use only (i.e., to
   one provider's own use, where no interoperability is deemed useful)
   may define private identifiers without need of coordination.
   However, when interoperability is wanted, coordination of the
   identifiers via, for example, publication of an informational RFC is
   RECOMMENDED in order to make Service-Context-Id globally available.</para>

      <para><emphasis> Default value is "32260@3gpp.org".
      </emphasis></para>

      <example>
        <title><varname>service_context_id_root</varname> parameter usage</title>

        <programlisting format="linespecific">
...
modparam("ims_charging", "service_context_id_root", "calls@kamailio-ims.org")
...
        </programlisting>
      </example>
    </section>

    <section>
      <title><varname>service_context_id_ext</varname> (string)</title>

      <para>This defines the extension of the Service-Context-Id AVP used
 in the diameter-message.</para>

      <para><emphasis> Default value is "ext".
      </emphasis></para>

      <example>
        <title><varname>service_context_id_ext</varname> parameter usage</title>

        <programlisting format="linespecific">
...
modparam("ims_charging", "service_context_id_ext", "ext2")
...
        </programlisting>
      </example>
    </section>

    <section>
      <title><varname>service_context_id_mnc</varname> (string)</title>

      <para>This defines Mobile-Network-Code (MNC) of the Service-Context-Id AVP used
 in the diameter-message.</para>

      <para><emphasis> Default value is "01".
      </emphasis></para>

      <example>
        <title><varname>service_context_id_mnc</varname> parameter usage</title>

        <programlisting format="linespecific">
...
modparam("ims_charging", "service_context_id_mnc", "42")
...
        </programlisting>
      </example>
    </section>

   <section>
      <title><varname>service_context_id_mcc</varname> (string)</title>

      <para>This defines Mobile-Country-Code (MCC) of the Service-Context-Id AVP used
 in the diameter-message.</para>
<para>see https://en.wikipedia.org/wiki/Mobile_country_code_(MCC) for details.</para>

      <para><emphasis> Default value is "001".
      </emphasis></para>

      <example>
        <title><varname>service_context_id_mcc</varname> parameter usage</title>

        <programlisting format="linespecific">
...
modparam("ims_charging", "service_context_id_mcc", "262")
...
        </programlisting>
      </example>
    </section>

   <section>
      <title><varname>service_context_id_release</varname> (string)</title>

      <para>This defines Release of the Service-Context-Id AVP used
 in the diameter-message.</para>
      <para><emphasis> Default value is "8" (Release 8).
      </emphasis></para>

      <example>
        <title><varname>service_context_id_release</varname> parameter usage</title>

        <programlisting format="linespecific">
...
modparam("ims_charging", "service_context_id_release", "262")
...
        </programlisting>
      </example>
    </section>

  </section>

  <section>
    <title>Functions</title>

    <section>
      <title><function
      moreinfo="none">Ro_CCR(route_name, direction, charge_type, unit_type, reservation_units)</function></title>

      <para>Perform a CCR on Diameter Ro interface for Charging</para>

      <para>Meaning of the parameters is as follows:</para>

      <itemizedlist>
        <listitem>
          <para><emphasis>route_name</emphasis> route to be executed upon reception of charging requests</para>
        </listitem>
        <listitem>
          <para><emphasis>direction</emphasis> "orig"inating or "term"inating</para>
        </listitem>
        <listitem>
          <para><emphasis>charge_type</emphasis> "IEC" = Immediate Event Charging, "ECUR" - Event Charging with Unit Reservation
or "SCUR" - Session Charging with Unit Reservation.</para>
<emphasis>
(Note: At the moment only SCUR is supported)
</emphasis>
        </listitem>
        <listitem>
          <para><emphasis>unit_type</emphasis> Types of the unit to be requested</para>
<emphasis>
(unused at the moment)
</emphasis>
        </listitem>
        <listitem>
          <para><emphasis>reservation_units</emphasis> how many units (at the moment seconds) should be reservated at the moment.</para>
        </listitem>

      </itemizedlist>

      <para>This function can be used from REQUEST_ROUTE.</para>

      <para>This method is executed asynchronously. See example on how to
      retrieve return value.</para>

      <example>
        <title>Ro_CCR</title>

        <programlisting format="linespecific">
...
	xlog("L_DBG","Sending initial CCR Request for call\n");
	Ro_CCR("CHARGING_CCR_REPLY", "orig", "SCUR", "", "30");
}

route[CHARGING_CCR_REPLY]
{
        xlog("L_DBG","cca_return code is $avp(s:cca_return_code)\n");

        switch ($avp(s:cca_return_code)){
            case 1: #success
                xlog("L_DBG", "CCR success - will route message\n");
                route(Finalize_Orig);
                break;
            case -1: #failure
                xlog("L_ERR", "CCR failure - error response sent from module\n");
                sl_send_reply("402","Payment required");
                break;
            case -2: #error
                xlog("L_ERR", "CCR error - error response sent from module\n");
                sl_send_reply("500", "Charging Error");
                break;
            default:
                xlog("L_ERR", "Unknown return code from CCR: [$avp(s:cca_return_code)] \n");
                break;
        }
        exit;
}

...
</programlisting>
      </example>
    </section>
    
   </section>

  <section>
    <title>Statistics</title>

    <section>
      <title>CCR Timeouts (ccr_timeouts)</title>

      <para>The number of timeouts on sending a CCR. i.e. no response to
      CCR.</para>
    </section>

    <section>
      <title>Average CCR Response Time (ccr_avg_response_time)</title>

      <para>The average response time in milliseconds for CCR-CCA
      transaction.</para>
    </section>
  </section>
</chapter>
